name: ğŸš€ Shipping Build

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: read   # <-- Needed if you use GITHUB_TOKEN to read GitHub Packages

jobs:
  FTP-Deploy-Action:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    env:
      # Use either a PAT with read:packages (recommended) OR the built-in GITHUB_TOKEN.
      # If using a PAT, create repo secret GH_PACKAGES_TOKEN and uncomment the first line.
      # NODE_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: "--max_old_space_size=4096"
      CI: false

    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'             # Better than caching node_modules
          cache-dependency-path: '**/package-lock.json'
          registry-url: 'https://registry.npmjs.org/'

      - name: ğŸ“„ Create .env file from GitHub Secrets
        run: |
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}" >> .env
          echo "NOVU_APP_ID=${{ secrets.NOVU_APP_ID }}" >> .env

      - name: ğŸ” Configure npm for GitHub Packages (scope-only)
        run: |
          echo "@StandardTouch:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          # sanity checks (no secrets printed)
          npm config get registry
          npm config get @StandardTouch:registry

      - name: ğŸ”¨ Install Dependencies
        run: npm ci

      - name: ğŸ— Build Project
        run: npm run build

      - name: ğŸ“‚ Sync folders and files to the server
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: dist/
